name: Deploy data pipeline

on:
  push:
    branches: [dev, main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04

    env:
      REPO_NAME: "quickstart_common.public.quickstart_repo"
      SNOWFLAKE_AUTHENTICATOR: "snowflake_jwt"
      SNOWFLAKE_CONNECTIONS_DEFAULT_AUTHENTICATOR: "SNOWFLAKE_JWT"
      SNOWFLAKE_CONNECTIONS_DEFAULT_PRIVATE_KEY_FILE: ".snowflake/snowflake_rsa_key"
      SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_USER: ${{ secrets.SNOWFLAKE_USER }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install CA certificates
        run: sudo apt-get update && sudo apt-get install -y ca-certificates

      - name: Configure Private Key
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .snowflake
          umask 177
          cat > .snowflake/snowflake_rsa_key <<'EOF'
${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
EOF
          chmod 600 .snowflake/snowflake_rsa_key
          head -n1 .snowflake/snowflake_rsa_key | grep -q "BEGIN PRIVATE KEY" || { echo "Not PKCS#8"; exit 1; }
          openssl pkey -in .snowflake/snowflake_rsa_key -noout

      - name: Install snowflake-cli
        uses: Snowflake-Labs/snowflake-cli-action@v1.5
        with:
          cli-version: "latest"
          default-config-file-path: ".snowflake/config.toml"

      - name: Fetch repository changes
        env:
          SNOWFLAKE_AUTHENTICATOR: "snowflake_jwt"
          SNOWFLAKE_PRIVATE_KEY_PATH: ${{ github.workspace }}/.snowflake/snowflake_rsa_key
        run: snow git fetch "${REPO_NAME}"

      - name: "Deploy data pipeline to ${{ github.ref_name }}"
        env:
          SNOWFLAKE_AUTHENTICATOR: "snowflake_jwt"
          SNOWFLAKE_PRIVATE_KEY_PATH: ${{ github.workspace }}/.snowflake/snowflake_rsa_key
        run: |
          set -euo pipefail
          BRANCH_NAME='${{ github.ref_name }}'
          if [ "${BRANCH_NAME}" = "main" ]; then
            RETENTION_TIME=1
          else
            RETENTION_TIME=0
          fi
          snow git execute \
            "@${REPO_NAME}/branches/${BRANCH_NAME}/steps/0[134]_*" \
            -D "environment=${BRANCH_NAME}" \
            -D "retention_time=${RETENTION_TIME}"
